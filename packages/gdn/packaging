#!/bin/bash

# This script is almost entirely based on
# https://github.com/concourse/bin/blob/master/ci/build-linux and
# https://github.com/concourse/bin/blob/master/scripts/build-linux

set -e -u -x

LINUX_ASSETS=$PWD/linux
BOSH_PACKAGES_DIR=/var/vcap/packages

mkdir -p ${BOSH_PACKAGES_DIR}/gdn/src
cp -a . ${BOSH_PACKAGES_DIR}/gdn/src/.

export GOROOT=$(readlink -nf ${BOSH_PACKAGES_DIR}/golang_1.7.1)
export GOPATH=${BOSH_PACKAGES_DIR}/gdn
export PATH=$GOROOT/bin:$PATH:$GOPATH/bin

rm -rf $LINUX_ASSETS
mkdir -p $LINUX_ASSETS/bin

# go-bindata does weird stuff with symlinks. we only care about iptables anyway
mkdir -p $LINUX_ASSETS/iptables/sbin
cp -aL ${BOSH_PACKAGES_DIR}/iptables/sbin/iptables $LINUX_ASSETS/iptables/sbin/iptables

go install github.com/jteeuwen/go-bindata/go-bindata/
go install code.cloudfoundry.org/guardian/cmd/init/
go install code.cloudfoundry.org/guardian/cmd/dadoo/

pushd code.cloudfoundry.org/guardian/rundmc/nstar
  make
  mv nstar $LINUX_ASSETS/bin
popd

# collect binaries
cp ${BOSH_PACKAGES_DIR}/runc/bin/runc $LINUX_ASSETS/bin
cp ${BOSH_PACKAGES_DIR}/tar/tar $LINUX_ASSETS/bin
cp ${BOSH_PACKAGES_DIR}/iptables/sbin/iptables $LINUX_ASSETS/bin
cp ${GOPATH}/bin/{init,dadoo} $LINUX_ASSETS/bin

go-bindata -nomemcopy -pkg bindata -o ${GOPATH}/src/code.cloudfoundry.org/gdn/bindata/bindata.go linux/...

# must be built with 'daemon' flag because of docker packages :|
go build \
  -tags daemon \
  -o binary/gdn \
  code.cloudfoundry.org/gdn/cmd/gdn

cp binary/gdn ${BOSH_INSTALL_TARGET}/bin

# cleanup
GDN_PATH=$(readlink ${BOSH_PACKAGES_DIR}/gdn)
rm -f ${GDN_PATH}/bin/{dadoo,go-bindata,init}
rm -rf ${GDN_PATH}/{src,pkg}
